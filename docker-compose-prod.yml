version: "3.9"
   
services:
    db:
        build:
            context: ./
            dockerfile: docker/db.Dockerfile
        volumes:
            - ./var/prod/pgdata:/var/lib/postgresql/data
        environment:
            - POSTGRES_USER=${DB_USER}
            - POSTGRES_PASSWORD=${DB_PASSWORD}
            - POSTGRES_DB=onlease
    web:
        restart: always
        build:
            context: ./
            dockerfile: docker/web.Dockerfile
        volumes:
            - .:/code
            - static_data:/vol/static
            - static_data:/vol/media
        ports:
            - "8000:8000"
        depends_on:
            - db
        environment:
            - DEBUG=0
            - BASE_URL=${BASE_URL}
            - GOOGLE_MAPS_API_KEY= ${GOOGLE_MAPS_API_KEY}
            - SECRET_KEY=${SECRET_KEY}
            - NG_ROK=${NG_ROK}
            - USE_NG_ROK=${USE_NG_ROK}
            - DB_PASSWORD=${DB_PASSWORD}
            - DB_USER=${DB_USER}
            - DB_PORT=${DB_PORT}
            - ALLOWED_HOSTS=${ALLOWED_HOSTS}
            - TF_APIKEY=${TF_APIKEY}
    nginx:
        build:
            context: ./
            dockerfile: docker/nginx.Dockerfile
        ports:
            - "80:8000"
            - "443:8000"
        volumes:
            - static_data:/vol/static
        depends_on:
            - web

volumes:
    static_data:
